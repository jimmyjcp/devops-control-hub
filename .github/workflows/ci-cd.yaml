name: CI/CD Pipeline

# --------------------------------------------------
# CU√ÅNDO SE EJECUTA EL PIPELINE
# --------------------------------------------------
on:
  push:
    branches:
      - main
  pull_request:

# --------------------------------------------------
# JOBS DEL PIPELINE
# --------------------------------------------------
jobs:

  # ------------------------------------------------
  # 1. BUILD: CONSTRUIR LA IMAGEN DOCKER
  # ------------------------------------------------
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t devops-control-hub:latest ./app


  # ------------------------------------------------
  # 2. SECURITY SCAN: DEVSECOPS
  # ------------------------------------------------
  security-scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.50.0_Linux-64bit.deb

      - name: Build image for scanning
        run: |
          docker build -t devops-control-hub:latest ./app

      - name: Scan Docker image
        run: |
          trivy image --severity HIGH,CRITICAL devops-control-hub:latest


  # ------------------------------------------------
  # 3. DEPLOY (PLACEHOLDER POR AHORA)
  # ------------------------------------------------
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Deploy placeholder
        run: |
          echo "Deploy step will be implemented later with Kubernetes"
